<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K线数据与Delta分析系统</title>
    <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --positive-color: #26a69a;
            --negative-color: #ef5350;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --border-color: #bdc3c7;
            --buy-color: #26a69a;
            --sell-color: #ef5350;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #1e222d;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 25px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: #2a2e39;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        select, button {
            padding: 8px 15px;
            border: 1px solid #3a3f4b;
            border-radius: 5px;
            background: #2a2e39;
            color: #e0e0e0;
            font-size: 0.9rem;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: #2a2e39;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: 500px;
        }

        .chart-header {
            padding: 15px 20px;
            background: #343844;
            border-bottom: 1px solid #3a3f4b;
            font-weight: 600;
            color: #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-body {
            padding: 0;
            height: calc(100% - 53px);
        }

        .chart {
            width: 100%;
            height: 100%;
        }

        .data-highlight {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .data-highlight {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .data-highlight {
                grid-template-columns: 1fr;
            }
        }

        .highlight-card {
            background: #2a2e39;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }

        .highlight-card.positive {
            border-left-color: var(--positive-color);
        }

        .highlight-card.negative {
            border-left-color: var(--negative-color);
        }

        .highlight-card h3 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #a0a0a0;
        }

        .highlight-card p {
            font-size: 1.4rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .data-table-container {
            overflow-x: auto;
            background: #2a2e39;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #3a3f4b;
        }

        th {
            background-color: #343844;
            font-weight: 600;
            color: #e0e0e0;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #343844;
        }

        .positive {
            color: var(--positive-color);
        }

        .negative {
            color: var(--negative-color);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #a0a0a0;
        }

        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: var(--negative-color);
            background: rgba(239, 83, 80, 0.1);
            border-radius: 8px;
            margin: 20px 0;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-top: 30px;
        }

        .legend {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>K线数据与Delta分析系统</h1>
            <p class="subtitle">K线与Delta同步分析</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="timeframe">时间周期:</label>
                <select id="timeframe">
                    <option value="1m">1分钟</option>
                    <option value="5m">5分钟</option>
                    <option value="15m">15分钟</option>
                    <option value="1h" selected>1小时</option>
                    <option value="4h">4小时</option>
                    <option value="1d">1天</option>
                </select>
            </div>

            <div class="control-group">
                <label for="limit">显示数量:</label>
                <select id="limit">
                    <option value="50">50条</option>
                    <option value="100" selected>100条</option>
                    <option value="200">200条</option>
                    <option value="500">500条</option>
                </select>
            </div>

            <div class="control-group">
                <label for="symbol">交易对:</label>
                <select id="symbol">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="BNBUSDT">BNB/USDT</option>
                </select>
            </div>

            <button id="refresh-btn">刷新数据</button>
            <button id="export-btn">导出数据</button>
        </div>

        <div class="data-highlight">
            <div class="highlight-card">
                <h3>最新价格</h3>
                <p id="current-price">-</p>
            </div>
            <div class="highlight-card">
                <h3>24小时涨跌幅</h3>
                <p id="price-change">-</p>
            </div>
            <div class="highlight-card">
                <h3>成交量Delta</h3>
                <p id="delta-value">-</p>
            </div>
            <div class="highlight-card">
                <h3>Delta方向</h3>
                <p id="delta-direction">-</p>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-header">
                    <span>K线图</span>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #26a69a;"></div>
                            <span>阳线</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ef5350;"></div>
                            <span>阴线</span>
                        </div>
                    </div>
                </div>
                <div class="chart-body">
                    <div id="klineChart" class="chart"></div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <span>成交量Delta</span>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #26a69a;"></div>
                            <span>正Delta</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ef5350;"></div>
                            <span>负Delta</span>
                        </div>
                    </div>
                </div>
                <div class="chart-body">
                    <div id="deltaChart" class="chart"></div>
                </div>
            </div>
        </div>

        <div class="data-table-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>开盘价</th>
                        <th>最高价</th>
                        <th>最低价</th>
                        <th>收盘价</th>
                        <th>成交量</th>
                        <th>Delta</th>
                        <th>Delta方向</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- 数据将通过JavaScript填充 -->
                </tbody>
            </table>
        </div>

        <footer>
            <p>K线数据与Delta分析系统 &copy; 2023 | 数据更新时间: <span id="update-time"></span></p>
        </footer>
    </div>

    <script>
        // 配置
        const config = {
            // 在实际应用中替换为您的API地址
            // apiUrl: 'https://api.example.com/kline-data',
            defaultLimit: 100,
            defaultSymbol: 'BTCUSDT',
            defaultTimeframe: '1h'
        };

        // 状态管理
        let state = {
            klineData: [],
            currentKline: null,
            charts: {
                kline: null,
                delta: null
            },
            series: {
                kline: null,
                delta: null
            },
            isSyncing: false // 防止同步循环
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeControls();
            initializeCharts();
            loadData();
            updateTime();

            // 设置定时刷新
            setInterval(updateTime, 1000);
            setInterval(loadData, 60000); // 每分钟刷新一次数据
        });

        // 初始化控制元素
        function initializeControls() {
            document.getElementById('refresh-btn').addEventListener('click', loadData);
            document.getElementById('export-btn').addEventListener('click', exportData);

            document.getElementById('timeframe').addEventListener('change', loadData);
            document.getElementById('limit').addEventListener('change', loadData);
            document.getElementById('symbol').addEventListener('change', loadData);
        }

        // 初始化图表
        function initializeCharts() {
            // K线图
            const klineChartElement = document.getElementById('klineChart');
            state.charts.kline = LightweightCharts.createChart(klineChartElement, {
                width: klineChartElement.clientWidth,
                height: klineChartElement.clientHeight,
                layout: {
                    backgroundColor: '#2a2e39',
                    textColor: '#e0e0e0',
                },
                grid: {
                    vertLines: {
                        color: '#3a3f4b',
                    },
                    horzLines: {
                        color: '#3a3f4b',
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#3a3f4b',
                },
                timeScale: {
                    borderColor: '#3a3f4b',
                    timeVisible: true,
                },
            });

            state.series.kline = state.charts.kline.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            // Delta图
            const deltaChartElement = document.getElementById('deltaChart');
            state.charts.delta = LightweightCharts.createChart(deltaChartElement, {
                width: deltaChartElement.clientWidth,
                height: deltaChartElement.clientHeight,
                layout: {
                    backgroundColor: '#2a2e39',
                    textColor: '#e0e0e0',
                },
                grid: {
                    vertLines: {
                        color: '#3a3f4b',
                    },
                    horzLines: {
                        color: '#3a3f4b',
                    },
                },
                rightPriceScale: {
                    borderColor: '#3a3f4b',
                },
                timeScale: {
                    borderColor: '#3a3f4b',
                    timeVisible: true,
                },
            });

            state.series.delta = state.charts.delta.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
            });
            state.charts.delta.priceScale('').applyOptions({
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });

            // 设置图表同步
            setupChartSync();

            // 窗口大小变化时调整图表大小
            window.addEventListener('resize', function() {
                state.charts.kline.resize(
                    document.getElementById('klineChart').clientWidth,
                    document.getElementById('klineChart').clientHeight
                );
                state.charts.delta.resize(
                    document.getElementById('deltaChart').clientWidth,
                    document.getElementById('deltaChart').clientHeight
                );
            });
        }

        // 设置图表同步
        function setupChartSync() {
            // K线图时间轴变化时同步到Delta图
            state.charts.kline.timeScale().subscribeVisibleTimeRangeChange((newRange) => {
                if (state.isSyncing) return;
                state.isSyncing = true;

                try {
                    state.charts.delta.timeScale().setVisibleRange(newRange);
                } catch (e) {
                    console.error('同步K线图到Delta图时出错:', e);
                }

                state.isSyncing = false;
            });

            // Delta图时间轴变化时同步到K线图
            state.charts.delta.timeScale().subscribeVisibleTimeRangeChange((newRange) => {
                if (state.isSyncing) return;
                state.isSyncing = true;

                try {
                    state.charts.kline.timeScale().setVisibleRange(newRange);
                } catch (e) {
                    console.error('同步Delta图到K线图时出错:', e);
                }

                state.isSyncing = false;
            });
        }

        // 加载数据 - 使用fetch API
        async function loadData() {
            try {
                showLoading();

                const timeframe = document.getElementById('timeframe').value;
                const limit = document.getElementById('limit').value;
                const symbol = document.getElementById('symbol').value;

                // 使用fetch API获取数据
                const data = await simulateApiCall(timeframe, limit, symbol);

                if (data && data.length > 0) {
                    state.klineData = data;
                    state.currentKline = data[data.length - 1]; // 最新K线

                    updateCharts();
                    updateCurrentData();
                    renderDataTable();
                } else {
                    showError('没有获取到数据');
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                showError('加载数据失败: ' + error.message);
            }
        }

        // 模拟API调用 - 在实际应用中替换为真实的API调用
        async function simulateApiCall(timeframe, limit, symbol) {
					const response = await fetch('https://fapi.binance.com/fapi/v1/klines?symbol='+symbol+'&limit='+limit+'&interval='+timeframe);
          const data = await response.json()
          return data;
        }

        // 生成模拟K线数据
        function generateMockKlineData(count) {
            const data = [];
            let baseTime = Date.now() - (count * 60 * 60 * 1000); // 从count小时前开始

            let basePrice = 30000; // 基础价格

            for (let i = 0; i < count; i++) {
                const openTime = baseTime + (i * 60 * 60 * 1000);
                const closeTime = openTime + (60 * 60 * 1000) - 1;

                // 随机生成价格波动
                const volatility = 0.02; // 2%波动
                const change = (Math.random() - 0.5) * 2 * volatility * basePrice;

                const openPrice = basePrice;
                const closePrice = basePrice + change;
                const highPrice = Math.max(openPrice, closePrice) + Math.random() * volatility * basePrice;
                const lowPrice = Math.min(openPrice, closePrice) - Math.random() * volatility * basePrice;

                // 生成成交量数据
                const volume = 1000 + Math.random() * 5000;
                const takerBuyVolume = volume * (0.3 + Math.random() * 0.4); // 主动买入占比30%-70%

                data.push([
                    openTime,
                    openPrice.toFixed(8),
                    highPrice.toFixed(8),
                    lowPrice.toFixed(8),
                    closePrice.toFixed(8),
                    volume.toFixed(8),
                    closeTime,
                    (volume * (openPrice + closePrice) / 2).toFixed(8),
                    Math.floor(10 + Math.random() * 100),
                    takerBuyVolume.toFixed(8),
                    (takerBuyVolume * (openPrice + closePrice) / 2).toFixed(8),
                    "0" // 忽略的参数
                ]);

                basePrice = closePrice;
            }

            return data;
        }

        // 计算Delta
        function calculateDelta(kline) {
            const totalVolume = parseFloat(kline[5]);
            const buyVolume = parseFloat(kline[9]);
            const sellVolume = totalVolume - buyVolume;
            const delta = buyVolume - sellVolume;

            return {
                totalVolume,
                buyVolume,
                sellVolume,
                delta,
                buyRatio: (buyVolume / totalVolume) * 100,
                sellRatio: (sellVolume / totalVolume) * 100,
                direction: delta >= 0 ? '多头主导' : '空头主导'
            };
        }

        // 更新图表数据
        function updateCharts() {
            // 准备K线数据
            const klineData = state.klineData.map(kline => {
                return {
                    time: kline[0] / 1000, // Lightweight Charts使用秒级时间戳
                    open: parseFloat(kline[1]),
                    high: parseFloat(kline[2]),
                    low: parseFloat(kline[3]),
                    close: parseFloat(kline[4])
                };
            });

            state.series.kline.setData(klineData);

            // 准备Delta数据
            const deltaData = state.klineData.map(kline => {
                const delta = calculateDelta(kline).delta;
                return {
                    time: kline[0] / 1000,
                    value: delta,
                    color: delta >= 0 ? '#26a69a' : '#ef5350'
                };
            });

            state.series.delta.setData(deltaData);
        }

        // 更新当前数据概览
        function updateCurrentData() {
            if (!state.currentKline) return;

            const kline = state.currentKline;
            const deltaData = calculateDelta(kline);

            // 计算价格变化
            const currentPrice = parseFloat(kline[4]);
            const openPrice = parseFloat(kline[1]);
            const priceChange = ((currentPrice - openPrice) / openPrice * 100).toFixed(2);
            const priceChangeText = priceChange >= 0 ? `+${priceChange}%` : `${priceChange}%`;

            document.getElementById('current-price').textContent = currentPrice.toFixed(2);
            document.getElementById('price-change').textContent = priceChangeText;
            document.getElementById('price-change').className = priceChange >= 0 ? 'positive' : 'negative';

            document.getElementById('delta-value').textContent = deltaData.delta.toFixed(2);
            document.getElementById('delta-value').className = deltaData.delta >= 0 ? 'positive' : 'negative';

            document.getElementById('delta-direction').textContent = deltaData.direction;
            document.getElementById('delta-direction').className = deltaData.delta >= 0 ? 'positive' : 'negative';
        }

        // 渲染数据表格
        function renderDataTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            // 只显示最近20条数据，避免表格过长
            const displayData = state.klineData.slice(-20);

            displayData.forEach((kline, index) => {
                const deltaData = calculateDelta(kline);
                const row = document.createElement('tr');

                const time = new Date(kline[0]).toLocaleString('zh-CN');

                row.innerHTML = `
                    <td>${time}</td>
                    <td>${kline[1]}</td>
                    <td>${kline[2]}</td>
                    <td>${kline[3]}</td>
                    <td>${kline[4]}</td>
                    <td>${parseFloat(kline[5]).toFixed(2)}</td>
                    <td class="${deltaData.delta >= 0 ? 'positive' : 'negative'}">${deltaData.delta.toFixed(2)}</td>
                    <td class="${deltaData.delta >= 0 ? 'positive' : 'negative'}">${deltaData.direction}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        // 导出数据
        function exportData() {
            if (state.klineData.length === 0) {
                alert('没有数据可导出');
                return;
            }

            // 创建CSV内容
            let csvContent = "时间,开盘价,最高价,最低价,收盘价,成交量,Delta,Delta方向\n";

            state.klineData.forEach(kline => {
                const deltaData = calculateDelta(kline);
                const time = new Date(kline[0]).toLocaleString('zh-CN');

                csvContent += `"${time}",${kline[1]},${kline[2]},${kline[3]},${kline[4]},${kline[5]},${deltaData.delta.toFixed(2)},${deltaData.direction}\n`;
            });

            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `kline_data_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 显示加载状态
        function showLoading() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '<tr><td colspan="8" class="loading">加载中...</td></tr>';
        }

        // 显示错误
        function showError(message) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = `<tr><td colspan="8" class="error">${message}</td></tr>`;
        }

        // 更新时间
        function updateTime() {
            const now = new Date();
            document.getElementById('update-time').textContent = now.toLocaleString('zh-CN');
        }
    </script>
</body>
</html>
